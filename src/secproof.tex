\section{Security Proof}
  \begin{figure}[H]
    \begin{systembox}{$\fpaynet{}_{\mathrm{, dummy}}$}
      \begin{algorithmic}[1]
        \State Upon receiving any message $M$ from \alice:
        \Indent
          \If{$M$ is a valid \fpaynet{} message from a player}
            \State send ($M, \alice$) to \simulator
          \EndIf
        \EndIndent
        \Statex

        \State Upon receiving any message ($M, \alice$) from \simulator:
        \Indent
          \If{$M$ is a valid \fpaynet{} message from \simulator}
            \State send $M$ to \alice
          \EndIf
        \EndIndent
      \end{algorithmic}
    \end{systembox}
    \caption{}
    \label{alg:fpaynet:dummy}
  \end{figure}

  \begin{figure}[H]
    \begin{simulatorbox}{$\simulator{}_{\mathrm{LN}}$}
      Expects the same messages as the protocol, but messages that the protocol
      expects to receive from \environment, the simulator expects to receive
      from $\fpaynet{}_{\mathrm{, dummy}}$ with the name of the player appended.
      The simulator internally executes one copy of the protocol per player.
      Upon receiving any message, the simulator runs the relevant code of the
      protocol copy tied to the appended player name. Mimicking the real-world
      case, if a protocol copy sends a message to another player, that message
      is passed to \adversary{} as if sent by the player and if \adversary{}
      allows the message to reach the receiver, then the simulator reacts by
      acting upon the message with the protocol copy corresponding to the
      recipient player. A message sent by a protocol copy to \environment{} will
      be routed by \simulator{} to $\fpaynet{}_{\mathrm{, dummy}}$ instead. To
      distinguish which player it comes from, \simulator{} also appends the
      player name to the message.
    \end{simulatorbox}
    \caption{}
    \label{alg:sim:ln}
  \end{figure}

  \begin{lemma}
    \label{lemma:dummy}
    $\textsc{Exec}^{\ledger}_{\Pi_{\mathrm{LN}}, \adversary_{\mathrm{d}},
    \environment} = \textsc{Exec}^{\fpaynet{}_{\mathrm{, dummy}},
    \ledger}_{\simulator_{\mathrm{LN}}, \environment}$
  \end{lemma}

  \begin{proof}
    Consider a message that \environment{} sends. In the real world, the
    protocol ITIs produce an output. In the ideal world, the message is given to
    $\simulator{}_{\mathrm{LN}}$ through $\fpaynet{}_{\mathrm{, dummy}}$. The
    former simulates the protocol ITIs of the real world (along with their coin
    flips) and so produces an output from the exact same distribution, which is
    given to \environment{} through $\fpaynet{}_{\mathrm{, dummy}}$. Thus the
    two outputs are indistinguishable.
  \end{proof}

  \begin{figure}[H]
    \begin{systembox}{$\fpaynet{}_{\mathrm{, Reg}}$}
      \begin{algorithmic}[1]
        \State For messages \textsc{register}, \textsc{registerDone} and
        \textsc{registered}, act like \fpaynet{}.
        \Statex

        \State Upon receiving any other message $M$ from \alice:
        \Indent
          \If{$M$ is a valid \fpaynet{} message from a player}
            \State send ($M, \alice$) to \simulator
          \EndIf
        \EndIndent
        \Statex

        \State Upon receiving any other message ($M, \alice$) from \simulator:
        \Indent
          \If{$M$ is a valid \fpaynet{} message from \simulator}
            \State send $M$ to \alice
          \EndIf
        \EndIndent
      \end{algorithmic}
    \end{systembox}
    \caption{}
    \label{alg:fpaynet:reg}
  \end{figure}

  \begin{figure}[H]
    \begin{simulatorbox}{$\simulator{}_{\mathrm{LN - Reg}}$}
      Like $\simulator{}_{\mathrm{LN}}$, but it does not accept
      (\textsc{registered}) from $\fpaynet{}_{\mathrm{, Reg}}$.
      Additional differences:
      \begin{algorithmic}[1]
        \State Upon receiving (\textsc{register}, \alice, delay, relayDelay,
        lastPoll) from $\fpaynet{}_{\mathrm{, Reg}}$:
        \Indent
          \State $\mathtt{delay} \text{ of \alice{} ITI } \gets \mathrm{delay}$
          \label{alg:sim:reg:delay}
          \State $\mathtt{relayDelay} \text{ of \alice{} ITI } \gets
          \mathrm{relayDelay}$
          \State $\mathtt{lastPoll} \text{ of \alice{} ITI } \gets
          \mathrm{lastPoll}$
          \State $\left(pk_{\alice}, sk_{\alice}\right) \text{ of \alice{} ITI }
          \gets \mathtt{KeyGen}()$
          \label{alg:sim:reg:keygen}
          \State send (\textsc{registerDone}, \alice, $pk_{\alice}$) to
          $\fpaynet{}_{\mathrm{, Reg}}$
        \EndIndent
      \end{algorithmic}
    \end{simulatorbox}
    \caption{}
    \label{alg:sim:reg}
  \end{figure}

  \begin{lemma}
    \label{lemma:reg}
    $\textsc{Exec}^{\fpaynet{}_{\mathrm{, dummy}},
    \ledger}_{\simulator_{\mathrm{LN}}, \environment} =
    \textsc{Exec}^{\fpaynet{}_{\mathrm{, Reg}},
    \ledger}_{\simulator_{\mathrm{LN - Reg}}, \environment}$
  \end{lemma}

  \begin{proof}
    When \environment{} sends (\textsc{register}, delay, relayDelay) to
    \alice{}, it receives as a response (\textsc{register}, \alice, delay,
    relayDelay, $pk_{\alice}$) where $pk_{\alice}$ is a public key generated by
    \texttt{KeyGen}() both in the real (c.f. Fig.~\ref{alg:protocol:support},
    line~\ref{alg:protocol:support:keygen}) and in the ideal world (c.f.
    Fig.~\ref{alg:sim:reg}, line~\ref{alg:sim:reg:keygen}).

    Furthermore, one (\textsc{read}) is sent to \ledger{} from \alice{} in both
    cases (Fig.~\ref{alg:protocol:support},
    line~\ref{alg:protocol:support:lastpoll} and Fig.~\ref{alg:fpaynet:support},
    line~\ref{alg:fpaynet:support:lastpoll}).

    Additionally, $\simulator{}_{\mathrm{LN - Reg}}$ ensures that the state of
    \alice{} ITI is exactly the same as what would have been in the case of
    $\simulator{}_{\mathrm{LN}}$, as
    lines~\ref{alg:protocol:support:delay}-\ref{alg:protocol:support:keygen} of
    Fig.~\ref{alg:protocol:support} change the state of \alice{} ITI in the same
    way as lines~\ref{alg:sim:reg:delay}-\ref{alg:sim:reg:keygen} of
    Fig.~\ref{alg:sim:reg}.

    Lastly, the fact that the state of the \alice{} ITIs are changed in the same
    way in both worlds, along with the same argument as in the proof of
    Lemma~\ref{lemma:dummy} ensures that the rest of the messages are responded
    in an indistinguishable way in both worlds.
  \end{proof}

  \begin{figure}[H]
    \begin{simulatorbox}{$\simulator{}_{\mathrm{LN - Reg - Open}}$}
      Like $\simulator{}_{\mathrm{LN - Reg}}$. Differences:
      \begin{algorithmic}[1]
        \State Upon receiving (\textsc{openChannel}, \alice, \bob, $x$,
        \textit{fchid}, \textit{tid}) from $\fpaynet{}_{\mathrm{, Open}}$:
        \Indent
          \If{both \alice{} and \bob{} are honest}
            \State Simulate the interaction between \alice{} and \bob{} in their
            respective ITI, as defined in
            Figures~\ref{alg:protocol:open:env}-\ref{alg:protocol:open:fundingSigned}.
            All messages should be handed to and received from \adversary, as in
            the real world execution.
            \State After sending (\textsc{fundingSigned}) as \bob{} to \alice,
            send $\left(\textsc{channelAnnounced}, \bob, p_{\alice, F}, p_{\bob,
            F}, \mathit{fchid}, \mathit{pchid}\right)$ to $\fpaynet{}_{\mathrm{,
            Open}}$.
            \State After submitting $F$ to \ledger{} as \alice, send
            $\left(\textsc{channelAnnounced}, \alice, p_{\alice, F}, p_{\bob,
            F}, \mathit{fchid}, \mathit{pchid}\right)$ to $\fpaynet{}_{\mathrm{,
            Open}}$.
          \ElsIf{\alice{} is honest, \bob{} is corrupted}
            \State Simulate \alice's part of the interaction between \alice{}
            and \bob{} in \alice's ITI, as defined in
            Figures~\ref{alg:protocol:open:env},~\ref{alg:protocol:open:acceptChannel},
            and~\ref{alg:protocol:open:fundingSigned}.All messages should be
            handed to and received from \adversary, as in the real world
            execution.
            \State After sending (\textsc{fundingSigned}) as \bob{} to \alice,
            send $\left(\textsc{channelAnnounced}, \bob, p_{\alice, F}, p_{\bob,
            F}, \mathit{fchid}, \mathit{pchid}\right)$ to $\fpaynet{}_{\mathrm{,
            Open}}$.
          \ElsIf{\alice{} is corrupted, \bob{} is honest}
            \State send (\textsc{openChannel}, \alice, \bob, $x$,
            \textit{fchid}, \textit{tid}) to simulated (corrupted) \alice
            \State Simulate \bob's part of the interaction between \alice{}
            and \bob{} in \bob's ITI, as defined in
            Figures~\ref{alg:protocol:open:openChannel}
            and~\ref{alg:protocol:open:fundingCreated}.
            All messages should be handed to and received from \adversary, as in
            the real world execution.
          \ElsIf{both \alice{} and \bob{} are corrupted}
            \State forward message to \adversary{} \Comment{\adversary{} may
            open the channel or not}
          \EndIf
        \EndIndent
        \Statex

        \State Upon receiving (\textsc{channelOpened}, \alice, \textit{fchid})
        from $\fpaynet{}_{\mathrm{, Open}}$:
        \Indent
          \State execute
          lines~\ref{alg:protocol:open:checkNew:prand}-\ref{alg:protocol:open:checkNew:send}
          of Fig.~\ref{alg:protocol:open:checkNew} with \alice's ITI
          \If{\bob{} is honest}
            \State expect the delivery of \alice's (\textsc{fundingLocked})
            message from \adversary
            \State simulate Fig.~\ref{alg:protocol:open:fundingLocked} with
            received message in \bob's ITI
          \EndIf
        \EndIndent
        \Statex

        \State Upon receiving (\textsc{checkNew}, \alice, \bob, \textit{tid})
        from $\fpaynet{}_{\mathrm{, Open}}$: \Comment{\alice{} should be
        corrupted}
        \Indent
          \State send (\textsc{checkNew}, \alice, \bob, \textit{tid}) as
          \environment{} to \adversary
          \If{\bob{} is honest}
            \State expect a (\textsc{fundingLocked}) message from \adversary
            \State simulate Fig.~\ref{alg:protocol:open:fundingLocked} with
            received message in \bob's ITI
          \EndIf
        \EndIndent
      \end{algorithmic}
    \end{simulatorbox}
    \caption{}
    \label{alg:sim:open}
  \end{figure}
