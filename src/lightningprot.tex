\ \\ \noindent {$\Pi_{\mathrm{LN}}$}
  \label{alg:lightningprot}
  \begin{algorithmic}[1]
    \State Initialisation:
      \State $\mathrm{blocked} = 0$
      \State Channels = $\emptyset$
      \State MyChannels = $\emptyset$
    \State
    \State Upon receiving (open, $\mathrm{sid}_{Bob}$, $x$) from $\mathcal{E}$:
      \If{$\mathcal{G}_{\mathrm{Ledger}}.\mathrm{balance}(Alice) - \mathrm{blocked} \geq
      x$}
        \State blocked = blocked + $x$
        \State Let tx be a suitable funding transaction
        \State Send (opening, $x$, tx) to $Bob$
        \State Send (INPUT, tx) to $\mathcal{G}_{\mathrm{Ledger}}$
        \State wait for tx to be confirmed \Comment{correct way to wait?}
        \State blocked = blocked - $x$
        \State MyChannels = MyChannels $\cup \left\{\left(\mathrm{sid}_{Alice},
        \mathrm{sid}_{Bob}, x, 0, \mathcal{H}\left(\mathrm{tx}\right)\right)\right\}$
        \State Send (opened, $Alice$, $Bob$, x, 0, $\mathcal{H}\left(\mathrm{tx}\right))$
        to $\mathcal{E}$
      \EndIf
    \State
    \State Upon receiving (opening, $x$, tx) from $Bob$:
      \State wait for tx to be confirmed
      \State MyChannels = MyChannels $\cup \left\{\left(\mathrm{sid}_{Alice},
      \mathrm{sid}_{Bob}, 0, x, \mathcal{H}\left(\mathrm{tx}\right)\right)\right\}$
      \State Send (opened, $Alice$, $Bob$, 0, x, $\mathcal{H}\left(\mathrm{tx}\right))$ to
      $\mathcal{E}$
    \State
    \State Upon receiving (newChannel, txid, $\mathrm{sid}_{Charlie},
    \mathrm{sid}_{Dave}$) from $Bob$:
      \If{there exists a tx with $\mathcal{H}\left(\mathrm{tx}\right) = \mathrm{txid}$ on
      $\mathcal{G}_{\mathrm{Ledger}}$ and is a valid funding transaction}
        \State Channels = Channels $\cup \left\{\left(\mathrm{sid}_{Charlie},
        \mathrm{sid}_{Dave}, \mathrm{txid}\right)\right\}$
      \EndIf
    \State
    \State Upon receiving (closedChannel, txid) from $Bob$:
      \If{there exists ad tx with $\mathcal{H}\left(\mathrm{tx}\right) = \mathrm{txid}$ on
      $\mathcal{G}_{\mathrm{Ledger}}$ that closes a funding tx' that corresponds to entry
      E of Channels}
        \State Channels = Channels $\setminus$ E
      \EndIf
    \State
    \State Upon receiving (pay, $Bob$, $x$) from $\mathcal{E}$:
      \State Send (sendInvoice, $x$) to $Bob$
      \State wait for response (invoice, $x$, hash) from $Bob$:
      \State Let $G$ be the payment network, as reflected by Channels and MyChannels
      \If{there is an $\left(Alice, v_1, \dots, v_n, Bob\right)$ path in $G$ where the
      first hop is of weight at least $x$}
        \State Send a Sphinx~\cite{sphinx} message with the correct HTLCs (containing
        hash) for $Bob$
        \State \Comment{Sane fees and timeouts as requested by each hop}
        \State Wait for (preimage) from $v_1$
        \If{$\mathcal{H}\left(\mathrm{preimage}\right) = \mathrm{hash}$}
          \State update $\left(\mathrm{sid}_{Alice}, \mathrm{sid}_{v_1}, y, z,
          \mathrm{txid}\right) \in \mathrm{MyChannels}$ to $\left(\mathrm{sid}_{Alice},
          \mathrm{sid}_{v_1}, y - x, z + x, \mathrm{txid}\right) \in \mathrm{MyChannels}$
          \Comment{Send relevant messages to $v_1$}
          \State send (paymentSuccessful, $Bob$, $x$) to $\mathcal{E}$
        \Else
          \State send (paymentFailed, $Bob$, $x$) to $\mathcal{E}$
        \EndIf
      \Else
        \State send (noPath, $Bob$, $x$) to $\mathcal{E}$
      \EndIf
    \State
    \State Upon receiving (sendInvoice, $x$) from $Bob$:
      \State $\mathrm{preimage} \overset{r}{\leftarrow}
      \left\{0,1\right\}^{\mathrm{gazillion}}$
      \State hash = $\mathcal{H}\left(\mathrm{preimage}\right)$
      \State Send (invoice, $x$, hash) to $Bob$
    \State
    \State Upon receiving (close, id) from $Alice$:
      \If{$\mathcal{G}_{Ledger}$ has a valid funding tx with
      $\mathcal{H}\left(\mathrm{tx}\right) = \mathrm{id}$}
        \State Try to close cooperatively \Comment{TODO}
        \If{cooperative closing fails} \Comment{TODO}
          \State Close unilaterally \Comment{TODO}
        \EndIf
      \EndIf
  \end{algorithmic}
\hrulefill
