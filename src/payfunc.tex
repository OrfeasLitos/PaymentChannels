\begin{functionality}{$\mathcal{F}_{\mathrm{PayNet}}$}
  \label{alg:payfunc}
  \funcsection{Interface (messages from $\mathcal{E}$)}
    \begin{itemize}
      \item (\textsc{register})
      \item (\textsc{setDelay}, delay)
      \item (\textsc{openChannel}, self, peer, selfCoins)
      \item (\textsc{closeChannel}, receipt)
      \item (\textsc{pay}, peer, coins, path, receipt)
    \end{itemize}

  \funcsection{Pseudocode}
  \begin{algorithmic}[1]
    \Function{receipt}{\texttt{channel}}
      \State $\left(Alice, Bob, x, y, \mathtt{delay}\left(Alice\right),
      \mathtt{delay}\left(Bob\right), seq, \mathrm{chid}\right) \gets
      \mathtt{channel}$
      \State \Return $\left(Alice, Bob, x, y, \mathrm{chid}\right)$
    \EndFunction
    \State

    \State Initialisation:
    \Indent
      \State $\mathtt{channels} \gets \emptyset$
    \EndIndent
    \State

    \State Upon receiving $\left(\textsc{register}\right)$ from $Alice$:
    \Indent
      \State $\mathtt{delay}\left(Alice\right) \gets 1\mathrm{day}$
      \Comment{default delay}
      \State send $\left(\textsc{register}, Alice\right)$ to $\mathcal{S}$
      \State assign reply to $\mathtt{onChainBalance}\left(Alice\right)$
      \State $\mathtt{offChainBalance} \gets 0$
    \EndIndent
    \State

    \State Upon receiving any message except for
    $\left(\textsc{register}\right)$ from $Alice$:
    \Indent
      \State ignore message if $Alice$ has not registered
      \State send (\textsc{Read}) to $\mathcal{G}_{\mathrm{Ledger}}$ as $Alice$
      and assign reply to $\Sigma_{Alice}$
      \State count all coins currently exclusively spendable by $Alice$ in
      $\Sigma_{Alice}$ (with $\mathtt{pubKey}\left(Alice\right)$ and possibly a
      preimage of a hash in $\mathtt{hashList}\left(Alice\right)$) and assign
      result to $\mathtt{onChainBalance}\left(Alice\right)$ \Comment{TOASK:
      should I specify further?}
    \EndIndent
    \State

    \State Upon receiving $\left(\textsc{setDelay}, \mathrm{delay}\right)$
    from $Alice$: \Comment{TODO: maybe remove delays}
    \Indent
      \State $\mathtt{delay}\left(Alice\right) \gets \mathrm{delay}$
    \EndIndent
    \State

    \State Upon receiving $\left(\textsc{openChannel}, Alice, Bob, x\right)$
    from $Alice$:
    \Indent
      \State ensure $\mathrm{onChainBalance}\left(Alice\right) \geq x$
      \State choose unique channel ID chid
      \State send $\left(\textsc{openChannel}, Alice, Bob, x\right)$ to
      $\mathcal{S}$ and ensure reply is \textsc{channelOpened} %TODO: split and
      %robustify reply
      \State $\mathrm{onChainBalance}\left(Alice\right) \gets
      \mathrm{onChainBalance}\left(Alice\right) - x$
      \State $\mathrm{offChainBalance}\left(Alice\right) \gets
      \mathrm{offChainBalance}\left(Alice\right) + x$
      \State add $\left(Alice, Bob, x, 0, \mathtt{delay}\left(Alice\right),
      \mathtt{delay}\left(Bob\right), 0, \mathrm{chid}\right)$ to
      \texttt{channels}
      \State mark newly added channel as unreported to $Bob$
      \State send (\textsc{channelOpened}, \textsc{receipt}(\texttt{channel}))
      to $Alice$
    \EndIndent
    \State

    \State Upon receiving $\left(\textsc{poll}\right)$ from $Alice$:
    \Indent
      \State $res \gets \emptyset$
      \ForAll{unreported open \texttt{channel}s that contain $Alice$}
        \State add \textsc{receipt}(\texttt{channel}) to $res$
        \State mark \texttt{channel} as reported
      \EndFor
      \ForAll{unreported closed \texttt{channel}s that contained $Alice$}
      \Comment{TODO: write better}
        \State add \textsc{closingState}(\texttt{channel}) to $res$
        \State remove \texttt{channel} from \texttt{channels}
      \EndFor
      \State \Return (\textsc{poll}, ret) $Alice$
    \EndIndent

    \State Upon receiving $\left(\textsc{pay}, Bob, x,
    \overrightarrow{\mathtt{path}}, \mathtt{receipt}\right)$ from $Alice$:
    \Indent
      %TODO
    \EndIndent
    \State

    \State Upon receiving (\textsc{closeChannel}, \texttt{receipt}) from $Alice$:
    \Indent
      \State ensure that \texttt{receipt} corresponds to an open
      $\mathtt{channel} \in \mathtt{channels}$ that contains $Alice$
      \State $\left(Alice, Bob, x, y, \mathrm{delayAlice}, \mathrm{delayBob},
      \mathrm{seq}, \mathrm{chid}\right) \gets \mathtt{channel}$ \Comment{or the
      other way around if $Bob$ opened the channel}
      \State send (\textsc{closeChannel}, \texttt{channel}) to $\mathcal{S}$ and
      ensure reply is (\textsc{channelClosed}, \texttt{channel})%TODO: split
      \State $\mathtt{onChainBalance}\left(Alice\right) \gets
      \mathtt{onChainBalance}\left(Alice\right) + x$
      \State $\mathtt{onChainBalance}\left(Bob\right) \gets
      \mathtt{onChainBalance}\left(Bob\right) + y$
      \State $\mathtt{offChainBalance}\left(Alice\right) \gets
      \mathtt{offChainBalance}\left(Alice\right) - x$
      \State $\mathtt{offChainBalance}\left(Bob\right) \gets
      \mathtt{offChainBalance}\left(Bob\right) - y$
      \State mark \textsc{channel} as unreported closed to $Bob$
      \State send (\textsc{channelClosed}, \texttt{channel}) to $Alice$
    \EndIndent
  \end{algorithmic}
\end{functionality}
