\begin{functionality}{$\mathcal{F}_{\mathrm{PayNet}}$}
  \label{alg:payfunc}
  \funcsection{Interface (messages from $\mathcal{E}$)}
    \begin{itemize}
      \item openChannel(peer, amount, etc)
      \item acceptChannel(peer, amount, etc)
      \item closeChannel(outpoint, etc)
      \item pay(invoice)
      \item checkBalance(invoice?)
    \end{itemize}
    Discussion: I avoided connect(), I added acceptChannel(), what about
    invoices?
  \funcsection{Pseudocode}
  \begin{algorithmic}[1]
    \State Initialisation:
      \Indent
      \ForAll{$v \in \mathcal{P}$}
        \State $\mathrm{blocked}\left(v\right) \gets 0$
      \EndFor
      \State $\mathtt{pending}, \mathtt{channels} \gets \emptyset$
      \EndIndent
    \State
    \State Upon receiving $\left(\textsc{openChannel}, Alice, Bob, x, y,
    \mathrm{AliceDelay}, \mathrm{forFundTX}\right)$ from $Alice$:
    \Indent
      \If{there is no $\left(Alice, Bob, x, y, \_, \_, \_\right)$ in
      \texttt{pending}}
        \State add $\left(Alice, Bob, x, y, \mathrm{AliceDelay},
        \mathrm{forFundTX}\right)$ to \texttt{pending}
        \State $\mathrm{blocked}\left(Alice\right) \leftarrow
        \mathrm{blocked}\left(Alice\right) + x$
        \State \Return $\left(Alice, Bob, x, y, \mathrm{AliceDelay}\right)$ to
        $Bob$ \Comment{TOASK: return to Bob but Alice called?}
      \EndIf
    \EndIndent
    \State
    \State Upon receiving $\left(\textsc{acceptChannel}, Alice, Bob, x, y,
    \mathrm{BobDelay}\right)$ from $Bob$: \Comment{This message does not exist
    in LND, because only one side funds the channel there.}
    \Indent
      \If{$\left(Alice, Bob, x, y, \_, \_\right) \in \mathtt{pending}$}
        \State assert($\mathcal{G}_{\mathrm{Ledger}}$.balance($Alice$) $\geq
        \mathrm{blocked}\left(Alice\right) + x$)
        \State assert($\mathcal{G}_{\mathrm{Ledger}}$.balance($Bob$) $\geq
        \mathrm{blocked}\left(Bob\right)$) \Comment{TODO: define balance}
        \State AliceDelay, forFundTX $\gets$ last 2 elements in $\left(Alice,
        Bob, x, y, \_, \_\right)$
        \State remove $\left(Alice, Bob, x, y, \_, \_\right)$ from
        \texttt{pending}
        \State $\mathrm{blocked}\left(Alice\right) \gets
        \mathrm{blocked}\left(Alice\right) - x$
        \State send \textsc{Read} to $\mathcal{G}_{\mathrm{Clock}}$ and assign
        reply to $\tau_L$
        \State send $\left(\mathtt{openChannel}, Alice, Bob, x, y,
        \mathrm{forFundTX}, \tau_L\right)$ to $\mathcal{A}$ \Comment{Keys
        generated by simulator TODO: may need delays}
        %\State $\mathtt{tx} \gets \left(\textsc{Funding}\left(x, y, pa_F, pb_F,
        %\mathrm{forFundTX}\right), \tau_L\right)$
        %\State add \texttt{tx} to \texttt{buffer}
        \State Choose a unique channel ID chid
        \State $\mathtt{channel} \gets \left(Alice, Bob, x, y,
        \mathrm{AliceDelay}, \mathrm{BobDelay}, 0, \mathrm{chid}\right)$
        \State add \texttt{channel} to \texttt{channels}
        \State $\mathtt{receipt} \gets \left(Alice, Bob, x, y,
        \mathrm{chid}\right)$
        \State \Return $\mathtt{receipt} \text{ to } Alice \text{ and } Bob$
        \Comment{Multiple returns?}
      \EndIf
    \EndIndent
    \State \Comment{DISCUSS: do we care for things that can happen in the
    all-malicious case?}
    \State \Comment{eg update based on older state}
    \State Upon receiving $\left(\textsc{pay}, Bob, x,
    \overrightarrow{\mathtt{path}}, \mathtt{receipt}\right)$ from $Alice$:
    \Indent
      \State condition 1: $\overrightarrow{\mathtt{path}}$ consists of players
      where for every adjacent $\left(Carol, Dave\right)$ pair there is a
      \texttt{channel} in \texttt{channels} with $Carol$ and $Dave$ and where
      $Carol$ has at least $x$.
      \State condition 2: \texttt{receipt} has the same ID as a channel in
      \texttt{channels} where $Alice$ has at least $x$ coins.
      \Comment{TODISCUSS: this excludes updates based on old states}
      \If{both condition 1 and condition 2 hold}
        \ForAll{$\left(Carol, Dave\right)$ pairs in
        $\overrightarrow{\mathtt{path}}$}
          \State $\mathtt{oldCh} \gets \left(Carol, Dave, y, z,
          \mathrm{CarolDelay}, \mathrm{DaveDelay}, \mathrm{seq},
          \mathrm{chid}\right) \in \mathtt{channels}$
          \State $\mathtt{newCh} \gets \left(Carol, Dave, y - x, z + x,
          \mathrm{CarolDelay}, \mathrm{DaveDelay}, \mathrm{seq} + 1,
          \mathrm{chid}\right)$
          \State add \texttt{newCh} to \texttt{channels}
          \State send $\left(Carol, Dave, y - x, z + x, \mathrm{chid}\right)$ to
          $Carol$ and $Dave$ \Comment{TODISCUSS: sending, not returning}
        \EndFor
        \State send message $\left(\textsc{payed}, Bob, x\right)$ to $Alice$
        \State send message $\left(\textsc{payedFrom}, Alice, x\right)$ to $Bob$
      \Else
        \State send message $\left(\textsc{invalidPath}, Bob, x\right)$ to
        $Alice$
      \EndIf
    \EndIndent
    \State
    \State Upon receiving (\textsc{close}, \texttt{receipt}) from $Alice$:
    \Indent
      \If{\texttt{receipt} contains $Alice$ and corresponds to a
      \texttt{channel} in \texttt{channels} (i.e. there is a \texttt{channel}
      that contains the \texttt{receipt} elements)}
        \State AliceDelay $\gets$ AliceDelay of \texttt{channel}
        \State send \textsc{Read} to $\mathcal{G}_{\mathrm{Clock}}$ and assign
        reply to $\tau_L$
        \State $\mathtt{tx} \gets
        \left(\textsc{Closing}\left(\mathtt{receipt}\right), \tau_L\right)$
        \State add \texttt{tx} to \texttt{buffer}
        \State Upon receiving (\textsc{close}, \texttt{receipt'}) from $Bob$
        within AliceDelay blocks:
        \If{\texttt{receipt} and \texttt{receipt'} have the same id and
        \texttt{receipt'} has a greater sequence number than \texttt{receipt}}
          \State $\mathtt{tx'} \gets
          \left(\textsc{Revoke}\left(\mathtt{receipt}, \mathtt{receipt'}\right),
          \tau_L\right)$
          \State add \texttt{tx'} to \texttt{buffer} \Comment{TODO: specify
          validate(\texttt{buffer}, \texttt{tx})}
        \EndIf
        \State remove all items in \texttt{channels} with the same chid as
        \texttt{receipt}
      \EndIf
    \EndIndent
  \end{algorithmic}
\end{functionality}
