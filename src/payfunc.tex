\begin{algorithm}
  \caption{$\mathcal{F}_{\mathrm{PayNet}}$}
  \label{alg:payfunc}
  \begin{algorithmic}[1]
    \State Initialisation:
      \Indent
      \ForAll{$v \in \mathcal{P}$}
        \State $\mathrm{blocked}\left(v\right) = 0$
      \EndFor
      \State Pending = $\emptyset$
      \State Channels = $\emptyset$
      \EndIndent
    \State
    \State Upon receiving (\textsc{open}, $Bob$, $x$, $y$) from $Alice$:
    \Indent
      \If{$\left(Bob, Alice, y, x\right) \in \mathrm{Pending}$}
        \State assert($\mathcal{G}_{\mathrm{Ledger}}$.balance($Alice$) $\geq
        \mathrm{blocked}\left(Alice\right) + x$)
        \State assert($\mathcal{G}_{\mathrm{Ledger}}$.balance($Bob$) $\geq
        \mathrm{blocked}\left(Bob\right)$)
        \State $\mathrm{Pending} \leftarrow \mathrm{Pending} \setminus
        \left\{\left(Bob, Alice, y, x\right)\right\}$
        \State $\mathrm{blocked}\left(Bob\right) = \mathrm{blocked}\left(Bob\right) - y$
        \State chid $\overset{r}{\leftarrow} \left\{0, 1\right\}^{\mathrm{gazillion}}$
        \State $\mathtt{tx} \gets \left(\textsc{Funding}\left(Alice, Bob, x, y\right),
        \mathrm{chid}, \tau_L, Bob\right)$
        \State $\mathtt{receipt} = \left(\mathrm{chid}, x, y, Alice, Bob,
        \State add \texttt{tx} to \texttt{buffer}
        \tau_L, 0\right)$
        \State $\mathrm{Channels} \leftarrow \mathrm{Channels} \cup
        \left\{\mathtt{receipt}\right\}$
        \State send \texttt{receipt} to $Alice$ and $Bob$
        %\State send message $\left(\mathrm{opened}, Alice, Bob, x, y, \mathrm{id}\right)$
        %to $Alice$
        %\State send message $\left(\mathrm{opened}, Bob, Alice, y, x, \mathrm{id}\right)$
        %to $Bob$
      \Else
        \State $\mathrm{Pending} \leftarrow \mathrm{Pending} \cup \left\{\left(Alice, Bob,
        x, y\right)\right\}$
        \State $\mathrm{blocked}\left(Alice\right) \leftarrow
        \mathrm{blocked}\left(Alice\right) + x$
      \EndIf
    \EndIndent
    \State
    \State Upon receiving $\left(\textsc{pay}, Bob, x,
    \vec{\mathtt{receipt}}\right)$ from $Alice$:
      \If{there is an $Alice \rightarrow Bob$ path of weight $x$ and
      $\vec{\mathtt{receipt}}$ corresponds to the saved (latest) respective channels}
    \Indent
        \State TODO: elaborate/revise if
        \ForAll{$\left(Carol, Dave, y, z, \mathrm{chid}\right)$ channel in the path}
          \State Update channel to $\left(Carol, Dave, y - x, z + x, \mathrm{chid}\right)$
          \State send a new \texttt{receipt} to $Carol$ and $Dave$
        \EndFor
        \State send message $\left(\textsc{payed}, Bob, x\right)$ to $Alice$
        \State send message $\left(\textsc{payedFrom}, Alice, x\right)$ to $Bob$
      \Else
        \State send message $\left(\textsc{noPath}, Bob, x\right)$ to $Alice$
      \EndIf
    \EndIndent
    \State
    \State Upon receiving (\textsc{close}, \texttt{receipt}) from $Alice$:
    \Indent
      \If{\texttt{receipt} corresponds to the saved (latest) $Alice-Bob$ channel
      and $\mathcal{G}_{Ledger}$ has a valid funding tx with chid}
        \State TODO: fix if
        \State close that channel
      \EndIf
    \EndIndent
  \end{algorithmic}
\end{algorithm}
