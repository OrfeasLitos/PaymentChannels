\begin{algorithm}
  \caption{$\mathcal{F}_{\mathrm{PayNet}}$}
  \label{alg:payfunc}
  \begin{algorithmic}[1]
    \State Initialisation:
      \Indent
      \ForAll{$v \in \mathcal{P}$}
        \State $\mathrm{blocked}\left(v\right) = 0$
      \EndFor
      \State \texttt{pending} = $\emptyset$
      \State Channels = $\emptyset$
      \EndIndent
    \State
    \State Upon receiving (\textsc{open}, $Bob$, $x$, $y$) from $Alice$:
    \Indent
      \If{$\left(Bob, Alice, y, x\right) \in \mathtt{pending}$}
        \State assert($\mathcal{G}_{\mathrm{Ledger}}$.balance($Alice$) $\geq
        \mathrm{blocked}\left(Alice\right) + x$)
        \State assert($\mathcal{G}_{\mathrm{Ledger}}$.balance($Bob$) $\geq
        \mathrm{blocked}\left(Bob\right)$)
        \State remove $\left\{\left(Bob, Alice, y, x\right)\right\}$ from
        \texttt{pending}
        \State $\mathrm{blocked}\left(Bob\right) = \mathrm{blocked}\left(Bob\right) - y$
        \State chid $\overset{r}{\leftarrow} \left\{0, 1\right\}^{\mathrm{gazillion}}$
        \State $\mathtt{tx} \gets \left(\textsc{Funding}\left(Alice, Bob, x, y\right),
        \mathrm{chid}, \tau_L, Bob\right)$
        \State add \texttt{tx} to \texttt{buffer}
        \State $\mathtt{receipt} = \left(x, y, Alice, Bob, \mathrm{chid},
        \tau_L, 0\right)$
        \State add \texttt{receipt} to \texttt{receipts}
        \State send \texttt{receipt} to $Alice$ and $Bob$
        %\State send message $\left(\mathrm{opened}, Alice, Bob, x, y, \mathrm{id}\right)$
        %to $Alice$
        %\State send message $\left(\mathrm{opened}, Bob, Alice, y, x, \mathrm{id}\right)$
        %to $Bob$
      \Else
        \State add $\left\{\left(Alice, Bob, x, y\right)\right\}$ to
        \texttt{pending}
        \State $\mathrm{blocked}\left(Alice\right) \leftarrow
        \mathrm{blocked}\left(Alice\right) + x$
      \EndIf
    \EndIndent
    \State
    \State Upon receiving $\left(\textsc{pay}, Bob, x, \overrightarrow{\mathtt{path}},
    \mathtt{receipt}\right)$ from $Alice$:
    \Indent
      \If{$\overrightarrow{\mathtt{path}}$ consists of players where all
      adjacent pairs have a $\left(y, \_\right)$-receipt in \texttt{receipts}
      for some $y \geq x$ and $\mathtt{receipt} = \left(\_, \_, Alice, Bob, \_,
      \_, \_\right) \in \mathtt{receipts}$}
        \ForAll{$\left(Carol, Dave\right)$ pairs in
        $\overrightarrow{\mathtt{path}}$}
          \State $\mathtt{oldReceipt} \gets \left(Carol, Dave, y, z,
          \mathrm{chid}\right) \in \mathtt{receipts}$
          \State $\mathtt{newReceipt} \gets \left(Carol, Dave, y - x, z + x,
          \mathrm{chid}\right)$
          \State replace \texttt{oldReceipt} with \texttt{newReceipt} in
          \texttt{receipts}
          \State send \texttt{newReceipt} to $Carol$ and $Dave$
        \EndFor
        \State send message $\left(\textsc{payed}, Bob, x\right)$ to $Alice$
        \State send message $\left(\textsc{payedFrom}, Alice, x\right)$ to $Bob$
      \Else
        \State send message $\left(\textsc{invalidPath}, Bob, x\right)$ to $Alice$
      \EndIf
    \EndIndent
    \State
    \State Upon receiving (\textsc{close}, \texttt{receipt}) from $Alice$:
    \Indent
      \If{\texttt{receipt} contains $Alice$ and is contained in \texttt{receipts}}
        \State $\mathtt{txid} \overset{r}{\gets} \left\{0,
        1\right\}^{\mathrm{gazillion}}$
        \State $\mathtt{tx} \gets
        \left(\textsc{Closing}\left(\mathtt{receipt}\right), \mathtt{txid},
        \tau_L, Alice\right)$
        \State add \texttt{tx} to \texttt{buffer}
      \EndIf
    \EndIndent
    \State TODO: Write/discuss \textsc{Funding}, \textsc{Closing}
  \end{algorithmic}
\end{algorithm}
